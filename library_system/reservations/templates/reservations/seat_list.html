{% extends 'reservations/base.html' %}

{% block title %}Available Seats - Library Seat Reservation{% endblock %}

{% block content %}
    <h2>Book a Seat</h2>

    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" id="searchForm">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="start_time" class="form-label">Date and Time</label>
                        <input type="datetime-local" class="form-control" id="start_time" name="start_time" required
                               min="{{ now|date:'Y-m-d\TH:i' }}"
                               value="{% if request.GET.start_time %}{{ request.GET.start_time }}{% else %}{{ now|date:'Y-m-d\TH:i' }}{% endif %}">
                    </div>
                    <div class="col-md-4">
                        <label for="duration" class="form-label">Duration (minutes)</label>
                        <select class="form-control" id="duration" name="duration" required>
                            <option value="5" {% if request.GET.duration == '5' %}selected{% endif %}>5 minutes</option>
                            <option value="30" {% if request.GET.duration == '30' %}selected{% endif %}>30 minutes</option>
                            <option value="60" {% if request.GET.duration == '60' %}selected{% endif %}>1 hour</option>
                            <option value="120" {% if request.GET.duration == '120' %}selected{% endif %}>2 hours</option>
                            <option value="180" {% if request.GET.duration == '180' %}selected{% endif %}>3 hours</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary d-block">Search Available Seats</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if seats %}
        <div class="row">
            {% for seat in seats %}
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Seat {{ seat.number }}</h5>
                            {% if seat.location or seat.description %}
                                <p class="card-text">
                                    {% if seat.location %}
                                        <strong>Location:</strong> {{ seat.location }}<br>
                                    {% endif %}
                                    {% if seat.description %}
                                        {{ seat.description }}
                                    {% endif %}
                                </p>
                            {% endif %}
                            <form action="{% url 'create_reservation' seat.id %}" method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="start_time" value="{{ start_time|date:'Y-m-d\TH:i' }}">
                                <input type="hidden" name="duration" value="{{ request.GET.duration }}">
                                <button type="submit" class="btn btn-success">Book This Seat</button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% elif request.GET.start_time %}
        <div class="alert alert-info">
            No seats available for the selected time and duration.
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date/time to now
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getMinutes() % 15); // Round to nearest 15 minutes
    const nowStr = now.toISOString().slice(0, 16);
    document.getElementById('start_time').min = nowStr;
    
    if (!document.getElementById('start_time').value) {
        document.getElementById('start_time').value = nowStr;
    }
});
</script>
{% endblock %}